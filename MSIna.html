<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INA-GRM</title>

  <style>
    :root { color-scheme: dark light; }
    html, body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0c; color:#eee; }
    header { text-align:center; padding:40px 16px 20px; }
    h1 { margin:0; font-size: clamp(1.6rem, 3.5vw, 2.4rem); }
    p.sub { margin:.4rem 0 0; color:#b7b7bd; }
    main { max-width:900px; margin: 0 auto; padding: 24px 16px 60px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; }
    button.item {
      background:#1a1b1e; border:1px solid #2a2c31; color:#fff; padding:14px 16px;
      border-radius:12px; cursor:pointer; text-align:left; transition: transform .06s ease, background .2s;
      user-select:none; outline:none;
    }
    button.item:hover { background:#1e2025; }
    button.item:active { transform: translateY(1px); }
    .item .title { font-weight:600; font-size:1rem; line-height:1.2; }
    .item .hint { font-size:.8rem; opacity:.8; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .modal { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); backdrop-filter: blur(2px); }
    .modal.open { display:grid; }
    .card { width:min(1100px,94vw); background:#141416; border:1px solid #26262a; border-radius:16px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.55); }
    .card header { padding:0 6px 10px; text-align:left; }
    .card h2 { margin:0; font-size:1.1rem; }
    .player { display:block; }

    /* Split AV + PDF */
    .split {
      display:grid; gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px) {
      .split { grid-template-columns: 1fr 1fr; }
    }
    .pane {
      background:#0f0f11; border:1px solid #232327; border-radius:12px; padding:10px;
    }
    .pane h3 { margin:0 0 8px; font-size:.95rem; font-weight:600; color:#cfcfd6; }
    audio, video { width:100%; border-radius:10px; background:#000; outline:none; }
    iframe.pdf { width:100%; height:70vh; border:0; border-radius:10px; background:#1a1b1e; }

    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .close {
      border:1px solid #2a2c31; background:#1b1c20; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; text-decoration:none;
    }
    .close:hover { background:#202228; }
    .footer-bar { margin-top:10px; display:flex; justify-content:flex-end; gap:8px; }
    .footer-note { margin-left:auto; font-size:.8rem; color:#a4a4aa; align-self:center; }
  </style>
</head>
<body oncontextmenu="return false;">

  <header>
    <h1>INA-GRM</h1>
    <p class="sub">Selecciona una pista para reproducir</p>
  </header>

  <main>
    <div id="list" class="grid" aria-live="polite"></div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="card" oncontextmenu="return false;">
      <header class="row">
        <h2 id="modalTitle">Reproducción</h2>
        <button class="close" id="closeBtn" type="button" aria-label="Cerrar">Cerrar ✕</button>
      </header>
      <div class="player" id="playerArea"></div>
      <div class="footer-bar">
        <div class="footer-note">Roberto Oliveira-Ogando</div>
      </div>
    </div>
  </div>

  <script>
    /* Bloqueos básicos */
    document.addEventListener('dragstart', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('copy', e => e.preventDefault());
    document.addEventListener('cut', e => e.preventDefault());
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      const key = e.key.toLowerCase();
      const ctrl = e.ctrlKey || e.metaKey;
      const blocked =
        (ctrl && ['s','p','u','o','i','j','c','+','-','0','a'].includes(key)) ||
        (key === 'f12') || (key === 'printscreen') || (key === 'f11');
      if (blocked) { e.preventDefault(); e.stopPropagation(); return false; }
    }, true);

    const listEl   = document.getElementById('list');
    const modal    = document.getElementById('modal');
    const modalT   = document.getElementById('modalTitle');
    const closeBtn = document.getElementById('closeBtn');
    const playerA  = document.getElementById('playerArea');

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    function closeModal() {
      const media = document.getElementById('media');
      if (media) { try { media.pause(); } catch {} }
      playerA.innerHTML = '';
      modal.classList.remove('open');
    }

    function isAudio(url) { return /\.(mp3|m4a|aac|wav|ogg)(\?|#|$)/i.test(url); }
    function isVideo(url) { return /\.(mp4|mov|webm|mkv)(\?|#|$)/i.test(url); }

    /* Normaliza enlaces de Dropbox a descarga directa */
    function normalizeDropbox(url) {
      try {
        const u = new URL(url);
        if (u.hostname.endsWith('dropbox.com')) {
          u.hostname = 'dl.dropboxusercontent.com';
          u.search = '';
          return u.toString();
        }
        return url;
      } catch { return url; }
    }

    /* Crea/inyecta iframe del visor (viewer.html) */
    function mountPdfViewer() {
      const ifr = document.createElement('iframe');
      ifr.className = 'pdf';
      ifr.id = 'pdfFrame';
      // sandbox sin downloads ni navegación
      ifr.setAttribute('sandbox', 'allow-scripts');
      ifr.src = 'viewer.html'; // archivo separado
      return ifr;
    }

    async function fetchPdfArrayBuffer(url) {
      const normalized = normalizeDropbox(url);
      const res = await fetch(normalized, { mode: 'cors', cache: 'no-store' });
      if (!res.ok) throw new Error('fetch PDF: ' + res.status);
      return await res.arrayBuffer();
    }

    async function openPlayer(title, mediaUrl, pdfUrl) {
      modalT.textContent = title || 'Reproducción';
      const safeMedia = String(mediaUrl || '').trim();
      const safePDF   = String(pdfUrl || '').trim();
      const tag = isVideo(safeMedia) ? 'video' : 'audio';

      const avPane = `
        <div class="pane">
          <h3>${tag === 'video' ? 'Vídeo' : 'Audio'}</h3>
          <${tag} id="media" controls
            controlsList="nodownload noplaybackrate noremoteplayback nofullscreen"
            preload="metadata" ${tag==='video' ? 'playsinline' : ''} src="${safeMedia}">
            Tu navegador no soporta el elemento de ${tag}.
          </${tag}>
        </div>`;

      const pdfPane = safePDF ? `
        <div class="pane">
          <h3>Documento</h3>
          <div id="pdfMount"></div>
        </div>` : '';

      playerA.innerHTML = `<div class="split">${avPane}${pdfPane}</div>`;

      const media = document.getElementById('media');
      if (media) {
        media.addEventListener('contextmenu', e => e.preventDefault());
        media.addEventListener('dragstart', e => e.preventDefault());
        try {
          if (media.tagName === 'VIDEO' && 'disablePictureInPicture' in HTMLVideoElement.prototype) {
            media.disablePictureInPicture = true;
          }
        } catch {}
			if (media) {
  media.addEventListener('error', () => {
    console.log('MEDIA ERROR ➜', media.error, 'src =', media.src);
  });
}
      }

      if (safePDF) {
        const mount = document.getElementById('pdfMount');
        const ifr = mountPdfViewer();
        mount.appendChild(ifr);

        // cuando el visor esté cargado, le mandamos el ArrayBuffer
        ifr.addEventListener('load', async () => {
          try {
            const buf = await fetchPdfArrayBuffer(safePDF);
            ifr.contentWindow?.postMessage({ type:'PDF_ARRAYBUFFER', payload: buf }, '*');
          } catch (e) {
            mount.innerHTML = '<div style="opacity:.8">No se pudo visualizar el PDF (CORS/origen).</div>';
            console.error(e);
          }
        }, { once:true });
      }

      modal.classList.add('open');
    }

    /* ------- CSV robusto ------- */
    function cleanText(t) { return t.replace(/^\uFEFF/, ''); }
    function parseWithDelim(text, delim) {
      const out = [];
      let row = [], field = '', inQ = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQ) {
          if (ch === '"') { if (text[i+1] === '"') { field += '"'; i++; } else { inQ = false; } }
          else field += ch;
        } else {
          if (ch === '"') inQ = true;
          else if (ch === delim) { row.push(field); field = ''; }
          else if (ch === '\n') { row.push(field); out.push(row); row = []; field = ''; }
          else if (ch === '\r') { /* skip */ }
          else field += ch;
        }
      }
      if (field.length || row.length) { row.push(field); out.push(row); }
      return out;
    }
    function detectDelim(text) {
      const candidates = [',',';','\t','|'];
      let best = ',', bestScore = -1;
      for (const d of candidates) {
        const rows = parseWithDelim(text, d);
        const useful = rows.filter(r => r.some(c => c && c.trim() !== ''));
        const widths = useful.map(r => r.length);
        const avg = widths.length ? (widths.reduce((a,b)=>a+b,0)/widths.length) : 0;
        if (avg > bestScore) { bestScore = avg; best = d; }
      }
      return best;
    }

    // CSV: [título, media, descripción, pdf]
    function toQuads(rows) {
      rows = rows.map(r => r.map(c => (c||'').trim()));
      const looksHeader = rows.length && rows[0][1] && !/^https?:\/\//i.test(rows[0][1]);
      if (looksHeader) rows = rows.slice(1);
      return rows
        .map(r => [r[0] || '', r[1] || '', r[2] || '', r[3] || ''])
        .filter(([t,u]) => t && u);
    }

    async function loadCSV() {
      try {
        const res = await fetch('Ina.csv', { cache: 'no-store' });
        if (!res.ok) throw new Error('No se pudo cargar Ina.csv');
        const raw = cleanText(await res.text());
        const delim = detectDelim(raw);
        const rows = parseWithDelim(raw, delim);
        const data = toQuads(rows);
        renderList(data);
      } catch (err) {
        console.error(err);
        listEl.innerHTML = `<div style="opacity:.8">
          No se pudo cargar <code>Ina.csv</code>. Asegúrate de que está en la misma carpeta que este <code>index.html</code>.
        </div>`;
      }
    }

    function renderList(items) {
      if (!items.length) {
        listEl.innerHTML = `<div style="opacity:.8">No existe ninguna pista de audio en este capítulo.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      for (const [title, url, desc, pdfUrl] of items) {
        const hint = desc ? desc : trimUrl(url);
        const btn = document.createElement('button');
        btn.className = 'item';
        btn.type = 'button';
        btn.innerHTML = `
          <div class="title">${escapeHTML(title)}</div>
          <div class="hint">${escapeHTML(hint)}${pdfUrl ? ' · PDF disponible' : ''}</div>
        `;
        btn.addEventListener('click', () => openPlayer(title, url, pdfUrl));
        frag.appendChild(btn);
      }
      listEl.innerHTML = '';
      listEl.appendChild(frag);
    }

    function trimUrl(u) { try { return new URL(u).hostname; } catch { return u; } }
    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    loadCSV();
  </script>
</body>
</html>